# Sacci Brand Hub — SSH & Git Deployment to SiteGround

This document covers:
1. Generating an SSH key and adding it to SiteGround
2. Creating a bare git repo on the server with a `post-receive` hook
3. Adding the server as a git remote
4. Day-to-day deploy workflow

---

## Prerequisites

| What | Where to find it |
|---|---|
| SiteGround SSH hostname | Site Tools → Devs → SSH Keys Manager → *Connection details* |
| SiteGround SSH username | Same panel (format: `uXXXXXXXX`) |
| SSH port | **18765** (SiteGround non-standard port) |
| Server deploy path | `/home/<user>/public_html/sacci_brand_hub` |

---

## Step 1 — Generate an SSH Key Pair (local machine)

```bash
ssh-keygen -t ed25519 -C "sacci-deploy" -f ~/.ssh/sacci_siteground
```

This creates:
- `~/.ssh/sacci_siteground` — private key (keep secret, never commit)
- `~/.ssh/sacci_siteground.pub` — public key (upload to SiteGround)

---

## Step 2 — Add the Public Key to SiteGround

1. Copy the public key:
   ```bash
   cat ~/.ssh/sacci_siteground.pub
   ```
2. In SiteGround: **Site Tools → Devs → SSH Keys Manager → Add New SSH Key**
3. Paste the public key content and save.

---

## Step 3 — Configure SSH Locally

Add an entry to `~/.ssh/config` so you can use a short alias:

```
Host sacci-sg
    HostName       <your-sg-ssh-hostname>   # e.g. premium123.web-hosting.com
    User           <your-sg-ssh-username>   # e.g. u12345678
    Port           18765
    IdentityFile   ~/.ssh/sacci_siteground
    IdentitiesOnly yes
```

Test the connection:
```bash
ssh sacci-sg
```

You should get a shell prompt on the SiteGround server.

---

## Step 4 — Create a Bare Git Repo on the Server

SSH into the server and run:

```bash
# Create a directory for the bare repo (outside public_html)
mkdir -p ~/repos/sacci_brand_hub.git
cd ~/repos/sacci_brand_hub.git
git init --bare

# Ensure the deploy target exists
mkdir -p ~/public_html/sacci_brand_hub
```

---

## Step 5 — Create the `post-receive` Hook

Still on the server, create the hook file:

```bash
cat > ~/repos/sacci_brand_hub.git/hooks/post-receive << 'HOOK'
#!/usr/bin/env bash
set -e

DEPLOY_DIR="$HOME/public_html/sacci_brand_hub"
GIT_WORK_TREE="$DEPLOY_DIR" git checkout -f main

echo ""
echo "=== Deployed to $DEPLOY_DIR ==="
HOOK

chmod +x ~/repos/sacci_brand_hub.git/hooks/post-receive
```

> **Note:** The hook checks out the `main` branch. If your production branch is
> different (e.g. `master` or `claude/setup-sacci-cms-W2QPe`), change `main`
> in the hook accordingly.

---

## Step 6 — Add the Server as a Git Remote (local machine)

```bash
git remote add siteground ssh://sacci-sg/home/<sg-username>/repos/sacci_brand_hub.git
```

Verify:
```bash
git remote -v
# siteground  ssh://sacci-sg/home/<sg-username>/repos/sacci_brand_hub.git (fetch)
# siteground  ssh://sacci-sg/home/<sg-username>/repos/sacci_brand_hub.git (push)
```

---

## Step 7 — First Deploy

```bash
# Push the target branch to SiteGround
git push siteground main
```

The `post-receive` hook will automatically check out the files into
`~/public_html/sacci_brand_hub`.

---

## Day-to-Day Deploy Workflow

```bash
# 1. Make changes locally
# 2. Commit
git add <files>
git commit -m "describe change"

# 3. Push to GitHub (source of truth)
git push origin main

# 4. Push to SiteGround (deploy)
git push siteground main
```

---

## Important: Files NOT Tracked in Git

These files exist on the server but must **not** be committed to the repo:

| File | Why |
|---|---|
| `.env` | Contains DB credentials and secrets |
| `vendor/` | Generated by Composer; install on server separately |
| `storage/` | User-uploaded files |

### First-time server setup after deploy

After the very first `git push siteground main`, SSH in and run:

```bash
cd ~/public_html/sacci_brand_hub

# Install Composer dependencies
composer install --no-dev --optimize-autoloader

# Verify .env exists (was created by the web installer)
ls -la .env
```

If `.env` was lost, re-create it by running the installer at
`https://sacci.space/sacci_brand_hub/install/` or copy from a backup.

---

## Verify the Deploy Worked

```bash
# SSH into server and check file timestamps
ssh sacci-sg "ls -la ~/public_html/sacci_brand_hub/"

# Or curl the site
curl -I https://sacci.space/sacci_brand_hub/
# Expected: HTTP/2 302 → redirects to /sacci_brand_hub/login
```

---

## Rollback

```bash
# Find the commit to roll back to
git log --oneline -10

# Push that commit to SiteGround
git push siteground <commit-sha>:main --force
```

---

## Troubleshooting

| Problem | Fix |
|---|---|
| `Permission denied (publickey)` | Check the key was added in SiteGround SSH Keys Manager; confirm `IdentityFile` in `~/.ssh/config` |
| `port 22: Connection refused` | SiteGround uses port **18765**, not 22 |
| Hook runs but files don't update | Confirm `GIT_WORK_TREE` path is correct; check hook has execute permission (`chmod +x`) |
| White page after deploy | SSH in, check `~/public_html/sacci_brand_hub/.env` exists and DB credentials are correct |
| `vendor/` missing after deploy | SSH in and run `composer install --no-dev` in the deploy dir |
